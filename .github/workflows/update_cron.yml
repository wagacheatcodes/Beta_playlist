name: Update VOD Data

on:
  workflow_dispatch:      # Allows you to click "Run workflow" manually
  schedule:
    - cron: '0 */6 * * *' # Optional: Runs automatically every 6 hours

jobs:
  generate-json:
    runs-on: ubuntu-latest
    # Set timeout slightly higher than your script limit (5h 30m = 330m)
    # 350m gives buffer time for setup and git pushing.
    timeout-minutes: 350

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Run Movies Generator
        # This script runs for max 5.5 hours, or until finished.
        # It saves to dist/movies.json every few minutes.
        run: python movies_runner.py

      - name: Run Series Generator
        # If movies finish early, this will run. 
        # If movies takes full 5.5h, this might skip until next run.
        # The script's "resume" logic handles this automatically.
        run: python series_runner.py

      - name: Commit and Push Changes
        # This logic fixes the "unstaged changes" error
        run: |
          echo "Configuring Git..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 1. Stage the 'dist' folder (where your scripts save data)
          git add dist/
          
          # 2. Check if there is anything to save
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected. Committing..."
            
            # 3. Commit LOCALLY first. 
            # This locks your new JSON data into the history so 'git pull' won't complain.
            git commit -m "Update VOD Data [skip ci]"
            
            # 4. Pull latest changes from GitHub (Rebase keeps history clean)
            git pull --rebase origin main
            
            # 5. Push the merged result back to GitHub
            git push origin main
            echo "Success! Data pushed to repository."
          else
            echo "No changes detected. Skipping push."
          fi
